--- openpetra.js.before/csharp/ICT/Common/Remoting/Shared/Serialization.cs	2014-08-29 15:39:26.000000000 +0200
+++ openpetra.js/csharp/ICT/Common/Remoting/Shared/Serialization.cs	2014-08-29 15:37:58.000000000 +0200
@@ -5,6 +5,7 @@
 //       timop
 //
 // Copyright 2004-2014 by OM International
+// Copyright 2013-2014 by SolidCharity
 //
 // This file is part of OpenPetra.org.
 //
@@ -158,6 +159,7 @@ public class GenerateServerGlue
 
         snippet.SetCodelet("LOCALVARIABLES", string.Empty);
         string returnCode = string.Empty;
+        int returnCounter = 0;
 
         foreach (ParameterDeclarationExpression p in AParameters)
         {
@@ -199,10 +201,12 @@ public class GenerateServerGlue
                 }
             }
 
+            bool EnumParameter = parametertype.EndsWith("Enum");
             bool BinaryParameter =
                 !((parametertype.StartsWith("System.Int64")) || (parametertype.StartsWith("System.Int32"))
                   || (parametertype.StartsWith("System.Int16"))
-                  || (parametertype.StartsWith("System.String")) || (parametertype.StartsWith("System.Boolean")));
+                  || (parametertype.StartsWith("System.String")) || (parametertype.StartsWith("System.Boolean"))
+                  || EnumParameter);
 
             if (ActualParameters.Length > 0)
             {
@@ -217,8 +221,7 @@ public class GenerateServerGlue
                     ParameterDefinition += ", ";
                 }
 
-                if ((!BinaryParameter)
-                    && (!ArrayParameter))
+                if ((!BinaryParameter) && (!ArrayParameter) && (!EnumParameter))
                 {
                     ParameterDefinition += parametertype + " " + p.ParameterName;
                 }
@@ -238,6 +241,16 @@ public class GenerateServerGlue
                     Environment.NewLine);
             }
 
+            // for string parameters, check if they have been encoded binary due to special characters in the string;
+            // this obviously does not apply to out parameters
+            if ((parametertype == "System.String") && ((ParameterModifiers.Out & p.ParamModifier) == 0))
+            {
+                snippet.AddToCodelet(
+                    "LOCALVARIABLES",
+                    p.ParameterName + " = (string) THttpBinarySerializer.DeserializeObject(" + p.ParameterName + ",\"System.String\");" +
+                    Environment.NewLine);
+            }
+
             if ((ParameterModifiers.Out & p.ParamModifier) != 0)
             {
                 snippet.AddToCodelet("LOCALVARIABLES", parametertype + " " + p.ParameterName + ";" + Environment.NewLine);
@@ -252,6 +265,13 @@ public class GenerateServerGlue
                         Environment.NewLine);
                     ActualParameters += "ref Local" + p.ParameterName;
                 }
+                else if (EnumParameter)
+                {
+                    snippet.AddToCodelet("LOCALVARIABLES", parametertype + " Local" + p.ParameterName + " = " +
+                        " (" + parametertype + ") Enum.Parse(typeof(" + parametertype + "), " + p.ParameterName + ");" +
+                        Environment.NewLine);
+                    ActualParameters += "ref Local" + p.ParameterName;
+                }
                 else
                 {
                     ActualParameters += "ref " + p.ParameterName;
@@ -264,6 +284,10 @@ public class GenerateServerGlue
                 {
                     ActualParameters += "(" + parametertype + ")THttpBinarySerializer.DeserializeObject(" + p.ParameterName + ",\"binary\")";
                 }
+                else if (EnumParameter)
+                {
+                    ActualParameters += " (" + parametertype + ") Enum.Parse(typeof(" + parametertype + "), " + p.ParameterName + ")";
+                }
                 else
                 {
                     ActualParameters += p.ParameterName;
@@ -272,11 +296,21 @@ public class GenerateServerGlue
 
             if (((ParameterModifiers.Ref & p.ParamModifier) > 0) || ((ParameterModifiers.Out & p.ParamModifier) > 0))
             {
+                if (returnCounter == 1)
+                {
+                    returnCode = "\"{ \\\"0\\\": \" + " + returnCode;
+                }
+
+                if (returnCounter > 0)
+                {
+                    returnCode += " + \", \\\"" + returnCounter.ToString() + "\\\": \" + ";
+                }
+
                 returnCode +=
-                    (returnCode.Length > 0 ? "+\",\"+" : string.Empty) +
                     "THttpBinarySerializer.SerializeObjectWithType(" +
                     (((ParameterModifiers.Ref & p.ParamModifier) > 0 && BinaryParameter) ? "Local" : string.Empty) +
                     p.ParameterName + ")";
+                returnCounter++;
             }
         }
 
@@ -303,11 +337,17 @@ public class GenerateServerGlue
                 returntype = returntype.Contains("Decimal") || returntype == "decimal" ? "System.Decimal" : returntype;
             }
 
-            if (returnCode.Length > 0)
+            if (returnCounter > 0)
             {
                 if (returntype != "void")
                 {
-                    returnCode += (returnCode.Length > 0 ? "+\",\"+" : string.Empty) + "THttpBinarySerializer.SerializeObjectWithType(Result)";
+                    if (returnCounter == 1)
+                    {
+                        returnCode = "\"{ \\\"0\\\": \" + " + returnCode;
+                    }
+
+                    returnCode += "+\", \\\"" + returnCounter.ToString() + "\\\": \"+" + "THttpBinarySerializer.SerializeObjectWithType(Result)";
+                    returnCounter++;
                 }
 
                 returntype = "string";
@@ -336,6 +376,11 @@ public class GenerateServerGlue
                 localreturn = "return ";
             }
 
+            if (returnCounter > 1)
+            {
+                returnCode += "+ \"}\"";
+            }
+
             snippet.SetCodelet("RETURN", string.Empty);
 
             if (returnCode.Length > 0)
diff --git a/csharp/ICT/Common/Remoting/Shared/Serialization.cs b/csharp/ICT/Common/Remoting/Shared/Serialization.cs
index 6344924..66f6b7d 100644
--- a/csharp/ICT/Common/Remoting/Shared/Serialization.cs
+++ b/csharp/ICT/Common/Remoting/Shared/Serialization.cs
@@ -5,6 +5,7 @@
 //       timop
 //
 // Copyright 2004-2014 by OM International
+// Copyright 2013-2014 by SolidCharity
 //
 // This file is part of OpenPetra.org.
 //
@@ -32,16 +33,73 @@ using System.Collections.Specialized;
 using System.Runtime.Serialization;
 using System.Runtime.Serialization.Formatters.Binary;
 using System.Reflection;
+using System.Web.Script.Serialization;
 using Ict.Common;
 using Ict.Common.IO;
 
 namespace Ict.Common.Remoting.Shared
 {
-    /// serialize and deserialize complex types in binary
+    /// serialize and deserialize complex types using JSON
+    /// TODO: rename the class
     public class THttpBinarySerializer
     {
+        static private string DataSetToJson(DataSet ADataset)
+        {
+            JavaScriptSerializer serializer = new JavaScriptSerializer();
+
+            Dictionary <string, List <Dictionary <string, object>>>dataset =
+                new Dictionary <string, List <Dictionary <string, object>>>();
+            List <Dictionary <string, object>>table = null;
+            Dictionary <string, object>row = null;
+
+            foreach (DataTable dt in ADataset.Tables)
+            {
+                table = new List <Dictionary <string, object>>();
+
+                foreach (DataRow dr in dt.Rows)
+                {
+                    row = new Dictionary <string, object>();
+
+                    foreach (DataColumn col in dt.Columns)
+                    {
+                        row.Add(col.ColumnName.Trim(), dr[col]);
+                    }
+
+                    table.Add(row);
+                }
+
+                dataset.Add(dt.TableName, table);
+            }
+
+            return serializer.Serialize(dataset);
+        }
+
+        static private string DataTableToJson(DataTable ATable)
+        {
+            JavaScriptSerializer serializer = new JavaScriptSerializer();
+
+            List <Dictionary <string, object>>table = null;
+            Dictionary <string, object>row = null;
+
+            table = new List <Dictionary <string, object>>();
+
+            foreach (DataRow dr in ATable.Rows)
+            {
+                row = new Dictionary <string, object>();
+
+                foreach (DataColumn col in ATable.Columns)
+                {
+                    row.Add(col.ColumnName.Trim(), dr[col]);
+                }
+
+                table.Add(row);
+            }
+
+            return serializer.Serialize(table);
+        }
+
         /// <summary>
-        /// serialize any object. if it is a complex type, use Base64
+        /// serialize any object. if it is a complex type, use JSON
         /// </summary>
         static public string SerializeObject(object o, bool binary)
         {
@@ -60,6 +118,21 @@ namespace Ict.Common.Remoting.Shared
                 return "null";
             }
 
+            if (o is Type)
+            {
+                return o.ToString();
+            }
+
+            if (o is DataSet)
+            {
+                return DataSetToJson((DataSet)o);
+            }
+
+            if (o is DataTable)
+            {
+                return DataTableToJson((DataTable)o);
+            }
+
             MemoryStream memoryStream = new MemoryStream();
             BinaryFormatter binaryFormatter = new BinaryFormatter();
             try
@@ -136,14 +209,12 @@ namespace Ict.Common.Remoting.Shared
 
             string result = SerializeObject(o, binary);
 
-            if (result.EndsWith(":binary"))
+            if ((result.Length > 0) && (result[0] != '{') && (result[0] != '['))
             {
-                return result;
-            }
-            else
-            {
-                return result + ":" + (binary ? "binary" : o.GetType().ToString());
+                result = "\"" + result + "\"";
             }
+
+            return result;
         }
 
         /// <summary>
@@ -156,6 +227,16 @@ namespace Ict.Common.Remoting.Shared
                 return null;
             }
 
+            if (s == null)
+            {
+                return null;
+            }
+
+            if ((type == "System.String") && s.EndsWith(":base64"))
+            {
+                return System.Text.UTF8Encoding.ASCII.GetString(Convert.FromBase64String(s.Substring(0, s.Length - ":base65".Length)));
+            }
+
             if (s.EndsWith(":binary"))
             {
                 type = "binary";
@@ -222,13 +303,17 @@ namespace Ict.Common.Remoting.Shared
 
                 throw new Exception("THttpBinarySerializer.DeserializeObject: unknown enum " + type);
             }
-            else // if (type == "binary" || true)
+            else if ((s != null) && (s.Length > 9)) // if (type == "binary" || true)
             {
                 MemoryStream memoryStream = new MemoryStream(Convert.FromBase64String(s));
                 memoryStream.Seek(0, SeekOrigin.Begin);
                 BinaryFormatter binaryFormatter = new BinaryFormatter();
                 return binaryFormatter.Deserialize(memoryStream);
             }
+            else
+            {
+                return null;
+            }
         }
     }
 }
